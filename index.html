<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Comisiones de Showrooms | Charo Ruiz Ibiza</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="header-content">
            <div>
                <div class="logo-text"><span class="logo-accent">&#9670;</span> Charo Ruiz Ibiza</div>
                <div class="header-subtitle">Sistema de Comisiones de Showrooms</div>
            </div>
            <div class="actions">
                <input type="file" id="importBackupInput" accept=".json" style="display:none">
                <button class="btn btn-secondary" onclick="exportarBackup()" title="Exportar copia de seguridad">&darr; Backup</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importBackupInput').click()" title="Restaurar desde copia de seguridad">&uarr; Restaurar</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Barra de búsqueda global -->
        <div style="margin-bottom: 24px;">
            <input type="text" id="busquedaGlobal" placeholder="Buscar en todo el sistema (facturas, pedidos, clientes, showrooms)..." style="width: 100%; padding: 12px 16px; font-size: 14px;" oninput="busquedaGlobalHandler()">
            <div id="resultadosBusqueda" style="display:none;"></div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('showrooms')">Showrooms</button>
            <button class="nav-tab" onclick="switchTab('clientes')">Clientes</button>
            <button class="nav-tab" onclick="switchTab('pedidos')">Pedidos</button>
            <button class="nav-tab" onclick="switchTab('facturas')">Facturas</button>
            <button class="nav-tab" onclick="switchTab('cobros')">Cobros</button>
            <button class="nav-tab" onclick="switchTab('informes')">Informes</button>
            <button class="nav-tab" onclick="switchTab('liquidaciones')">Liquidaciones</button>
            <button class="nav-tab" onclick="switchTab('historico')">Hist&oacute;rico</button>
        </div>

        <!-- TAB: DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Comisiones Proyectadas -->
            <div class="card" id="comisionesProyectadasCard">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">$</div>
                        <div class="card-title">Comisiones Proyectadas</div>
                    </div>
                </div>
                <div id="comisionesProyectadasContainer"></div>
            </div>

            <!-- Informe de Antigüedad de Deuda -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">A</div>
                        <div class="card-title">Antig&uuml;edad de Deuda</div>
                    </div>
                </div>
                <div id="agingReportContainer"></div>
            </div>

            <!-- Facturas Pendientes de Cobro -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">!</div>
                        <div class="card-title">Facturas Pendientes de Cobro</div>
                    </div>
                </div>
                <div id="facturasPendientesContainer"></div>
            </div>
        </div>

        <!-- TAB: SHOWROOMS -->
        <div id="tab-showrooms" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">S</div>
                        <div class="card-title">Showrooms</div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="modalShowroom()">+ Nuevo Showroom</button>
                        <button class="btn btn-secondary" onclick="exportarShowrooms()">&darr; Exportar</button>
                        <button class="btn btn-primary" onclick="document.getElementById('importShowroomsInput').click()">&uarr; Importar</button>
                    </div>
                </div>
                <input type="file" id="importShowroomsInput" accept=".xlsx,.csv" style="display:none">
                <div class="alert alert-info" id="showroomsAlert"></div>
                <div class="table-container" id="showroomsTable"></div>
            </div>
        </div>

        <!-- TAB: CLIENTES -->
        <div id="tab-clientes" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">C</div>
                        <div class="card-title">Clientes</div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="modalCliente()">+ Nuevo Cliente</button>
                        <button class="btn btn-secondary" onclick="exportarClientes()">&darr; Exportar</button>
                        <button class="btn btn-primary" onclick="document.getElementById('importClientesInput').click()">&uarr; Importar</button>
                    </div>
                </div>
                <input type="file" id="importClientesInput" accept=".xlsx,.csv" style="display:none">
                <div class="alert alert-info" id="clientesAlert"></div>
                <div class="table-container" id="clientesTable"></div>
            </div>
        </div>

        <!-- TAB: PEDIDOS -->
        <div id="tab-pedidos" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">P</div>
                        <div class="card-title">Pedidos</div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="modalPedido()">+ Nuevo Pedido</button>
                        <button class="btn btn-primary" onclick="document.getElementById('importPedidosInput').click()">&uarr; Importar</button>
                    </div>
                </div>
                <input type="file" id="importPedidosInput" accept=".xlsx,.csv" style="display:none">
                <div class="alert alert-info" id="pedidosAlert"></div>
                <div class="table-container" id="pedidosTable"></div>
            </div>
        </div>

        <!-- TAB: FACTURAS -->
        <div id="tab-facturas" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">F</div>
                        <div class="card-title">Facturas</div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="modalFactura()">+ Nueva Factura</button>
                        <button class="btn btn-primary" onclick="document.getElementById('importFacturasInput').click()">&uarr; Importar</button>
                    </div>
                </div>
                <input type="file" id="importFacturasInput" accept=".xlsx,.csv" style="display:none">
                <div class="alert alert-info" id="facturasAlert"></div>
                <div class="table-container" id="facturasTable"></div>
            </div>
        </div>

        <!-- TAB: COBROS -->
        <div id="tab-cobros" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">$</div>
                        <div class="card-title">Cobros</div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-success" onclick="modalCobro()">+ Nuevo Cobro</button>
                        <button class="btn btn-primary" onclick="document.getElementById('importCobrosInput').click()">&uarr; Importar</button>
                    </div>
                </div>
                <input type="file" id="importCobrosInput" accept=".xlsx,.csv" style="display:none">
                <div class="alert alert-info" id="cobrosAlert"></div>
                <div class="table-container" id="cobrosTable"></div>
            </div>
        </div>

        <!-- TAB: INFORMES -->
        <div id="tab-informes" class="tab-content">
            <!-- Informe de Comisiones -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">R</div>
                        <div class="card-title">Informe de Comisiones</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="infFechaInicio">Fecha Inicio (fecha cobro)</label>
                        <input type="date" id="infFechaInicio">
                    </div>
                    <div class="form-group">
                        <label for="infFechaFin">Fecha Fin (fecha cobro)</label>
                        <input type="date" id="infFechaFin">
                    </div>
                </div>
                <div class="form-group">
                    <label for="infShowroom">Showroom (Opcional)</label>
                    <select id="infShowroom">
                        <option value="">Todos los showrooms</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="generarInforme()">Generar Informe Excel</button>
                <div id="infPreview" class="table-container" style="display:none; margin-top:24px"></div>
            </div>

            <!-- Comparativa entre Periodos -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">VS</div>
                        <div class="card-title">Comparativa entre Periodos</div>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Periodo 1 - Inicio</label>
                        <input type="date" id="cmpInicio1">
                    </div>
                    <div class="form-group">
                        <label>Periodo 1 - Fin</label>
                        <input type="date" id="cmpFin1">
                    </div>
                    <div class="form-group">
                        <label>Periodo 2 - Inicio</label>
                        <input type="date" id="cmpInicio2">
                    </div>
                    <div class="form-group">
                        <label>Periodo 2 - Fin</label>
                        <input type="date" id="cmpFin2">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generarComparativa()">Generar Comparativa</button>
                <div id="comparativaResultado" style="margin-top: 20px;"></div>
            </div>

            <!-- Extracto por Cliente -->
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">E</div>
                        <div class="card-title">Extracto por Cliente</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="extCliente">Cliente</label>
                    <select id="extCliente">
                        <option value="">Seleccionar cliente...</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="generarExtractoCliente()">Ver Extracto</button>
                <div id="extractoResultado" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- TAB: LIQUIDACIONES -->
        <div id="tab-liquidaciones" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">L</div>
                        <div class="card-title">Liquidaciones de Comisiones</div>
                    </div>
                    <button class="btn btn-success" onclick="modalLiquidacion()">+ Nueva Liquidaci&oacute;n</button>
                </div>
                <div class="alert alert-info" id="liquidacionesAlert"></div>
                <div class="table-container" id="liquidacionesTable"></div>
            </div>
        </div>

        <!-- TAB: HISTORICO INFORMES -->
        <div id="tab-historico" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-header-left">
                        <div class="card-icon">H</div>
                        <div class="card-title">Hist&oacute;rico de Informes</div>
                    </div>
                    <button class="btn btn-danger btn-icon" onclick="limpiarHistoricoInformes()" title="Limpiar hist&oacute;rico">&times;</button>
                </div>
                <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
                    <input type="text" id="buscarHistorico" placeholder="Buscar en hist&oacute;rico..." style="flex: 1; min-width: 200px;">
                    <select id="filtroShowroomHistorico" style="min-width: 200px;">
                        <option value="">Todos los showrooms</option>
                    </select>
                </div>
                <div id="historicoInformesContainer"></div>
            </div>
        </div>
    </div>

    <!-- MODALES -->

    <!-- Modal Showroom -->
    <div id="modalShowroom" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalShowroomTitle">Nuevo Showroom</h3>
                <button class="modal-close" onclick="cerrarModal('modalShowroom')">&times;</button>
            </div>
            <div class="form-group">
                <label for="showNombre">Nombre del Showroom *</label>
                <input type="text" id="showNombre" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="showComision">% Comisi&oacute;n *</label>
                    <input type="number" id="showComision" step="0.01" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label for="showIdioma">Idioma del Informe *</label>
                    <select id="showIdioma" required>
                        <option value="es">Espa&ntilde;ol</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalShowroom')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarShowroom()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="modalCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalClienteTitle">Nuevo Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modalCliente')">&times;</button>
            </div>
            <div class="form-group">
                <label for="cliNombre">Nombre del Cliente *</label>
                <input type="text" id="cliNombre" required>
            </div>
            <div class="form-group">
                <label for="cliShowroom">Showroom Asignado *</label>
                <select id="cliShowroom" required>
                    <option value="">Seleccionar showroom...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalCliente')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCliente()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Pedido -->
    <div id="modalPedido" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalPedidoTitle">Nuevo Pedido</h3>
                <button class="modal-close" onclick="cerrarModal('modalPedido')">&times;</button>
            </div>
            <div class="form-group">
                <label for="pedNumero">N&uacute;mero de Pedido *</label>
                <input type="text" id="pedNumero" required>
            </div>
            <div class="form-group">
                <label for="pedCliente">Cliente *</label>
                <select id="pedCliente" required>
                    <option value="">Seleccionar cliente...</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="pedFecha">Fecha *</label>
                    <input type="date" id="pedFecha" required>
                </div>
                <div class="form-group">
                    <label for="pedMoneda">Moneda *</label>
                    <select id="pedMoneda" required>
                        <option value="EUR">EUR (&euro;)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="pedImporte">Importe *</label>
                <input type="number" id="pedImporte" step="0.01" min="0" required>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalPedido')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarPedido()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Factura -->
    <div id="modalFactura" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalFacturaTitle">Nueva Factura</h3>
                <button class="modal-close" onclick="cerrarModal('modalFactura')">&times;</button>
            </div>
            <div class="form-group">
                <label>Tipo de documento *</label>
                <div class="form-row" style="gap: 8px; margin-bottom: 8px;">
                    <button type="button" id="facTipoFactura" class="btn btn-primary" onclick="cambiarTipoFactura('factura')" style="flex:1;">Factura</button>
                    <button type="button" id="facTipoAbono" class="btn btn-secondary" onclick="cambiarTipoFactura('abono')" style="flex:1;">Rectificativa / Abono</button>
                </div>
            </div>
            <div class="form-group">
                <label for="facNumero">N&uacute;mero de Factura *</label>
                <input type="text" id="facNumero" required>
            </div>
            <div class="form-group">
                <label for="facCliente">Cliente *</label>
                <select id="facCliente" required onchange="cargarPedidosCliente(); cargarFacturasAbonables()">
                    <option value="">Seleccionar cliente...</option>
                </select>
            </div>
            <div class="form-group" id="facPedidosGroup">
                <label>Pedido(s) Origen</label>
                <div id="pedidosCheckboxes" style="margin-bottom: 4px;"></div>
                <input type="hidden" id="facPedidos">
                <small id="pedidosDisponiblesInfo" style="color: var(--gray-500); font-size: 13px; display: block; margin-top: 4px;">Selecciona un cliente para ver sus pedidos</small>
            </div>
            <div class="form-group" id="facAbonoGroup" style="display:none;">
                <label>Factura(s) que abona *</label>
                <div id="facturasAbonablesCheckboxes" style="margin-bottom: 4px;"></div>
                <input type="hidden" id="facFacturasAbonadas">
                <small id="facturasAbonablesInfo" style="color: var(--gray-500); font-size: 13px; display: block; margin-top: 4px;">Selecciona un cliente para ver sus facturas</small>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="facFecha">Fecha Emisi&oacute;n *</label>
                    <input type="date" id="facFecha" required>
                </div>
                <div class="form-group">
                    <label for="facVencimiento">Fecha Vencimiento *</label>
                    <input type="date" id="facVencimiento" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="facMoneda">Moneda *</label>
                    <select id="facMoneda" required>
                        <option value="EUR">EUR (&euro;)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="facImporte" id="facImporteLabel">Importe *</label>
                    <input type="number" id="facImporte" step="0.01" min="0" required>
                    <small id="facImporteHelp" style="color: var(--gray-500); font-size: 13px; display: none; margin-top: 4px;">Introduce el importe en positivo. Se guardar&aacute; como negativo.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalFactura')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarFactura()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Cobro -->
    <div id="modalCobro" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalCobroTitle">Nuevo Cobro</h3>
                <button class="modal-close" onclick="cerrarModal('modalCobro')">&times;</button>
            </div>
            <div class="form-group">
                <label>Aplicar cobro a *</label>
                <div class="form-row" style="gap: 8px; margin-bottom: 8px;">
                    <button type="button" id="cobTipoFactura" class="btn btn-primary" onclick="cambiarTipoCobro('factura')" style="flex:1;">Factura</button>
                    <button type="button" id="cobTipoPedido" class="btn btn-secondary" onclick="cambiarTipoCobro('pedido')" style="flex:1;">Pedido (Anticipo)</button>
                </div>
            </div>
            <div class="form-group" id="cobFacturaGroup">
                <label for="cobFactura">Factura *</label>
                <select id="cobFactura" required onchange="mostrarInfoCobro()">
                    <option value="">Seleccionar factura...</option>
                </select>
            </div>
            <div class="form-group" id="cobPedidoGroup" style="display:none;">
                <label for="cobPedido">Pedido *</label>
                <select id="cobPedido" onchange="mostrarInfoCobro()">
                    <option value="">Seleccionar pedido...</option>
                </select>
            </div>
            <div id="infoFactura" class="info-box" style="display:none;">
                <div class="info-row">
                    <span style="color: var(--gray-700);">Importe total:</span>
                    <strong id="infFactTotal">0,00 EUR</strong>
                </div>
                <div class="info-row">
                    <span style="color: var(--gray-700);">Ya cobrado:</span>
                    <strong id="infFactCobrado">0,00 EUR</strong>
                </div>
                <div class="info-row">
                    <span style="color: var(--gray-700);">Pendiente:</span>
                    <strong id="infFactPendiente" style="color: var(--warning);">0,00 EUR</strong>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="cobFecha">Fecha de Cobro *</label>
                    <input type="date" id="cobFecha" required>
                </div>
                <div class="form-group">
                    <label for="cobMoneda">Moneda *</label>
                    <select id="cobMoneda" required>
                        <option value="EUR">EUR (&euro;)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="cobImporte">Importe *</label>
                <input type="number" id="cobImporte" step="0.01" min="0" required>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalCobro')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCobro()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmacion Saldo Residual -->
    <div id="modalSaldoResidual" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Saldo Residual Detectado</h3>
                <button class="modal-close" onclick="cerrarModal('modalSaldoResidual')">&times;</button>
            </div>
            <p style="margin-bottom: 24px; color: var(--gray-700);" id="mensajeSaldoResidual"></p>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalSaldoResidual')">Dejar Pendiente</button>
                <button class="btn btn-primary" onclick="marcarComoCompleto()">Marcar como Pagada al 100%</button>
            </div>
        </div>
    </div>

    <!-- Modal Liquidación -->
    <div id="modalLiquidacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalLiquidacionTitle">Nueva Liquidaci&oacute;n</h3>
                <button class="modal-close" onclick="cerrarModal('modalLiquidacion')">&times;</button>
            </div>
            <div class="form-group">
                <label for="liqShowroom">Showroom *</label>
                <select id="liqShowroom" required>
                    <option value="">Seleccionar showroom...</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="liqFechaInicio">Periodo Inicio *</label>
                    <input type="date" id="liqFechaInicio" required>
                </div>
                <div class="form-group">
                    <label for="liqFechaFin">Periodo Fin *</label>
                    <input type="date" id="liqFechaFin" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="liqMoneda">Moneda *</label>
                    <select id="liqMoneda" required>
                        <option value="EUR">EUR (&euro;)</option>
                        <option value="USD">USD ($)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="liqImporte">Importe Pagado *</label>
                    <input type="number" id="liqImporte" step="0.01" min="0" required>
                </div>
            </div>
            <div class="form-group">
                <label for="liqFechaPago">Fecha de Pago *</label>
                <input type="date" id="liqFechaPago" required>
            </div>
            <div class="form-group">
                <label for="liqNotas">Notas</label>
                <textarea id="liqNotas" rows="2"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal('modalLiquidacion')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarLiquidacion()">Guardar</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-logo">Charo Ruiz Ibiza</div>
        <p>Sistema de Comisiones de Showrooms v2.0</p>
    </footer>

    <script src="app.js"></script>
</body>
</html>
